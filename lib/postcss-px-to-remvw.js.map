{"version":3,"file":"postcss-px-to-remvw.js","sources":["../src/utils.js","../src/Converter.js","../src/index.js"],"sourcesContent":["/**\n * Mix properties into target object.\n */\nexport const extend = function extend (to, _from) {\n  for (var key in _from) {\n    to[key] = _from[key]\n  }\n  return to\n}\n\n/**\n * Function equal to merge with the difference being that no reference\n * to original objects is kept.\n *\n * @see merge\n * @param {Object} obj1 Object to merge\n * @returns {Object} Result of all merge properties\n */\nexport function deepMerge(/* obj1, obj2, obj3, ... */) {\n  var result = {}\n  function assignValue(val, key) {\n    if (typeof result[key] === 'object' && typeof val === 'object') {\n      result[key] = deepMerge(result[key], val)\n    } else if (typeof val === 'object') {\n      result[key] = deepMerge({}, val)\n    } else {\n      result[key] = val\n    }\n  }\n\n  for (var i = 0, l = arguments.length; i < l; i++) {\n    forEach(arguments[i], assignValue)\n  }\n  return result\n}\n\n/**\n * Iterate over an Array or an Object invoking a function for each item.\n *\n * If `obj` is an Array callback will be called passing\n * the value, index, and complete array for each item.\n *\n * If 'obj' is an Object callback will be called passing\n * the value, key, and complete object for each property.\n *\n * @param {Object|Array} obj The object to iterate\n * @param {Function} fn The callback to invoke for each item\n */\nexport function forEach (obj, fn) {\n  // Don't bother if no value provided\n  if (obj === null || typeof obj === 'undefined') {\n    return\n  }\n\n  // Force an array if not already something iterable\n  if (typeof obj !== 'object') {\n    /* eslint no-param-reassign:0 */\n    obj = [obj]\n  }\n\n  if (isArray(obj)) {\n    // Iterate over array values\n    for (var i = 0, l = obj.length; i < l; i++) {\n      fn(obj[i], i, obj)\n    }\n  } else {\n    // Iterate over object keys\n    for (var key in obj) {\n      if (Object.prototype.hasOwnProperty.call(obj, key)) {\n        fn(obj[key], key, obj)\n      }\n    }\n  }\n}\n\n/**\n * Determine if a value is an Array\n *\n * @param {Object} val The value to test\n * @returns {boolean} True if value is an Array, otherwise false\n */\nexport const isArray = function (val) {\n  return toString.call(val) === '[object Array]';\n}\n","import css from 'css'\nimport { extend, deepMerge } from './utils'\n\nconst pxRegExp = /\\b(\\d+(\\.\\d+)?)px\\b/\nconst pxGlobalRegExp = new RegExp(pxRegExp.source, 'g')\nconst defaultConfig = {\n  baseSize: { rem: 75, vw: 7.5 },\n  precision: 6,\n  forceRemProps: ['font', 'font-size'],\n  keepRuleComment: 'no',\n  keepFileComment: 'pxtoremvw-disable',\n  toRem: true,\n  // disableToRemComment: 'pxtoremvw-disable-rem',\n  toVw: true,\n  // disableToVwComment: 'pxtoremvw-disable-vw',\n}\n\nexport default class PxConverter {\n  constructor(options = {}) {\n    this.config = extend({}, defaultConfig, options)\n    // this.originConfig = deepMerge(this.config)\n  }\n\n  convert(cssText) {\n    const astObj = css.parse(cssText)\n    const firstRule = astObj.stylesheet.rules[0]\n    if (!firstRule) return cssText\n    // 忽略整个文件\n    const isDisabled = firstRule.type === 'comment' &&\n      firstRule.comment.trim() === this.config.keepFileComment\n    if (isDisabled) return cssText\n\n    // const disableToVw = firstRule.type === 'comment' &&\n    //   firstRule.comment.trim() === this.config.disableToVwComment\n    // if (disableToVw) {\n    //   this.config.toVw = false\n    // } else {\n    //   this.config.toVw = this.originConfig.toVw\n    // }\n\n    // const disableToRem = firstRule.type === 'comment' &&\n    //   firstRule.comment.trim() === this.config.disableToRemComment\n    // if (disableToRem) {\n    //   this.config.toRem = false\n    // } else {\n    //   this.config.toRem = this.originConfig.toRem\n    // }\n\n    this.processRules(astObj.stylesheet.rules)\n    return css.stringify(astObj)\n  }\n\n  processRules(rules) {\n    rules.forEach(rule => {\n      if (rule.type === 'media') return this.processRules(rule.rules)\n      if (rule.type === 'keyframes') return this.processRules(rule.keyframes)\n      if (rule.type !== 'rule' && rule.type !== 'keyframe') return\n\n      const processDeclarations = index => {\n        const dec = rule.declarations[index]\n        if (!dec) return\n\n        // 必须为可转换的规则，否则去下一条\n        if (dec.type !== 'declaration' || !pxRegExp.test(dec.value)) return processDeclarations(index + 1)\n\n        // 如果下一条规则为禁用注释，一起跳过\n        const nextDec = rule.declarations[index + 1]\n        const isDisabled = nextDec &&\n          nextDec.type === 'comment' &&\n          nextDec.comment.trim() === this.config.keepRuleComment\n        if (isDisabled) {\n          return processDeclarations(index + 2)\n        }\n\n        const sourceValue = dec.value\n        // 将原本的 px 替换为 rem\n        if (this.config.toRem) {\n          dec.value = this.getCalcValue('rem', sourceValue)\n        }\n        // 增加一条更高级的 vw 规则用于覆盖\n        if (this.config.toVw && this.config.forceRemProps.indexOf(dec.property) === -1) {\n          rule.declarations.splice(index + 1, 0, {\n            type: 'declaration',\n            property: dec.property,\n            value: this.getCalcValue('vw', sourceValue),\n          })\n          processDeclarations(index + 2)\n        } else {\n          processDeclarations(index + 1)\n        }\n      }\n\n      processDeclarations(0)\n    })\n  }\n\n  getCalcValue(targetUnit, sourceValue) {\n    const baseSize = this.config.baseSize[targetUnit]\n    if (!baseSize) return sourceValue\n\n    return sourceValue.replace(pxGlobalRegExp, ($0, $1) => {\n      return `${parseFloat(($1 / baseSize).toFixed(this.config.precision))}${targetUnit}`\n    })\n  }\n}\n","import postcss from 'postcss'\nimport Converter from './Converter'\n\nconst plugin = postcss.plugin('postcss-px-to-remvw', options => {\n  return (css, result) => {\n    if (options.exclude) {\n      if (Object.prototype.toString.call(options.exclude) !== '[object RegExp]') {\n        throw new Error('options.exclude should be RegExp!')\n      }\n      if (css.source.input.file.match(options.exclude) !== null) {\n        result.root = css\n        return\n      }\n    }\n    const converter = new Converter(options)\n    const targetCssText = converter.convert(css.toString())\n    result.root = postcss.parse(targetCssText)\n  }\n})\n\nexport default plugin\n"],"names":["extend","to","_from","key","pxRegExp","pxGlobalRegExp","RegExp","source","defaultConfig","baseSize","rem","vw","precision","forceRemProps","keepRuleComment","keepFileComment","toRem","toVw","PxConverter","config","cssText","astObj","css","parse","firstRule","stylesheet","rules","type","comment","trim","this","processRules","stringify","forEach","rule","_this","keyframes","processDeclarations","index","dec","declarations","test","value","nextDec","sourceValue","getCalcValue","indexOf","property","splice","targetUnit","replace","$0","$1","parseFloat","toFixed","_this2","plugin","postcss","options","result","exclude","Object","prototype","toString","call","Error","input","file","match","root","targetCssText","Converter","convert"],"mappings":"2jBAGA,IAAaA,OAAS,SAAiBC,EAAIC,OACpC,IAAIC,KAAOD,EACdD,EAAGE,GAAOD,EAAMC,UAEXF,GCJHG,SAAW,sBACXC,eAAiB,IAAIC,OAAOF,SAASG,OAAQ,KAC7CC,cAAgB,CACpBC,SAAU,CAAEC,IAAK,GAAIC,GAAI,KACzBC,UAAW,EACXC,cAAe,CAAC,OAAQ,aACxBC,gBAAiB,KACjBC,gBAAiB,oBACjBC,OAAO,EAEPC,MAAM,GAIaC,iEAEZC,OAASnB,OAAO,GAAIQ,oEAInBY,OACAC,EAASC,IAAIC,MAAMH,GACnBI,EAAYH,EAAOI,WAAWC,MAAM,UACrCF,EAEiC,YAAnBA,EAAUG,MAC3BH,EAAUI,QAAQC,SAAWC,KAAKX,OAAOJ,gBACpBK,QAkBlBW,aAAaV,EAAOI,WAAWC,OAC7BJ,IAAIU,UAAUX,IAvBED,uCA0BZM,cACXA,EAAMO,SAAQ,SAAAC,MACM,UAAdA,EAAKP,KAAkB,OAAOQ,EAAKJ,aAAaG,EAAKR,UACvC,cAAdQ,EAAKP,KAAsB,OAAOQ,EAAKJ,aAAaG,EAAKE,cAC3C,SAAdF,EAAKP,MAAiC,aAAdO,EAAKP,OAEL,SAAtBU,EAAsBC,OACpBC,EAAML,EAAKM,aAAaF,MACzBC,MAGY,gBAAbA,EAAIZ,OAA2BvB,SAASqC,KAAKF,EAAIG,OAAQ,OAAOL,EAAoBC,EAAQ,OAG1FK,EAAUT,EAAKM,aAAaF,EAAQ,MACvBK,GACA,YAAjBA,EAAQhB,MACRgB,EAAQf,QAAQC,SAAWM,EAAKhB,OAAOL,uBAEhCuB,EAAoBC,EAAQ,OAG/BM,EAAcL,EAAIG,MAEpBP,EAAKhB,OAAOH,QACduB,EAAIG,MAAQP,EAAKU,aAAa,MAAOD,IAGnCT,EAAKhB,OAAOF,OAA6D,IAArDkB,EAAKhB,OAAON,cAAciC,QAAQP,EAAIQ,WAC5Db,EAAKM,aAAaQ,OAAOV,EAAQ,EAAG,EAAG,CACrCX,KAAM,cACNoB,SAAUR,EAAIQ,SACdL,MAAOP,EAAKU,aAAa,KAAMD,KAEjCP,EAAoBC,EAAQ,IAE5BD,EAAoBC,EAAQ,IAIhCD,CAAoB,4CAIXY,EAAYL,cACjBnC,EAAWqB,KAAKX,OAAOV,SAASwC,UACjCxC,EAEEmC,EAAYM,QAAQ7C,gBAAgB,SAAC8C,EAAIC,mBACpCC,YAAYD,EAAK3C,GAAU6C,QAAQC,EAAKpC,OAAOP,oBAAcqC,MAHnDL,WC/FpBY,OAASC,QAAQD,OAAO,uBAAuB,SAAAE,UAC5C,SAACpC,EAAKqC,MACPD,EAAQE,QAAS,IACqC,oBAApDC,OAAOC,UAAUC,SAASC,KAAKN,EAAQE,eACnC,IAAIK,MAAM,wCAEmC,OAAjD3C,EAAIf,OAAO2D,MAAMC,KAAKC,MAAMV,EAAQE,qBACtCD,EAAOU,KAAO/C,OAKZgD,EADY,IAAIC,YAAUb,GACAc,QAAQlD,EAAIyC,YAC5CJ,EAAOU,KAAOZ,QAAQlC,MAAM+C"}